<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Plupload: FileUploader</title>

<script src="../loader.js"></script>

<script type="text/javascript">

QUnit.config.reorder = false;
QUnit.config.testTimeout = 10000;

function getItemAt(idx, queue) {
    var foundItem;
    queue.forEachItem(function(item, i) {
        if (i === idx) {
            foundItem = item;
            return false;
        }
    });
    return foundItem;
}

module("FileUploader", {
    setup: function() {
        var self = this;
        var rt = new moxie.runtime.RuntimeTarget();

        rt.bind('RuntimeInit', function() {
            self.file = new moxie.file.File(rt.ruid, {
                name: 'test.jpg',
                size: Utils.random(1, 3) * Math.pow(2, 15) // bytes
            });

            self.options = {
                auto_start: true,
                chunk_size: 0,
                url: 'upload.php',
                file_data_name: 'filedata',
                send_file_name: false
            };

            self.queue = new plupload.QueueUpload(self.options);

            QUnit.start();
        });

        QUnit.stop();
        rt.connectRuntime({
            runtime_order: 'test'
        });
    },

    teardown: function() {
        this.queue.destroy();
        this.file.destroy();
    }
});


test("Options: chunk_size=0 (default), send_file_name=false", function() {
    var self = this;
    var up = new plupload.FileUploader(this.file, this.queue);

    up.bind('started', function() {

        ok(true, "started event has been dispatched.");

        equal(self.queue.stats.queued, 1,
            "One item added to the queue.");

        var item = getItemAt(0, self.queue);
        ok(item instanceof plupload.ChunkUploader,
            "Item is an instance of plupload.ChunkUploader.");

        deepEqual(item.getOptions(), {
                file_data_name: 'file',
                headers: false,
                http_method: 'POST',
                multipart: true,
                params: {},
                send_file_name: false,
                url: 'upload.php'
            },
            "Options have expected values.");

    });

    up.bind('resumed', function() {
        this.start();
    });

    up.bind('processed', function() {
        QUnit.start();
    });

    up.setOptions(plupload.extend({}, self.options, {
        file_data_name: 'file'
    }));

    QUnit.stop();
    up.start();
});


test("Options: chunk_size='200kb'", function() {
    var self = this;

    var dispatched = {
        'started': 0,
        'beforestart': 0,
        //'chunkuploadfailed': 0,
        'chunkuploaded': 0,
        'progress': 0,
        //'paused': 0
    };

    var up = new plupload.FileUploader(this.file, this.queue);

    var chunkSize = plupload.parseSize('10kb');
    var chunksNum = Math.ceil(this.file.size / chunkSize);

     // monitor events
    plupload.each(dispatched, function(num, type) {
        up.bind(type, function() {
            dispatched[type]++;
        });
    });

    up.bind('resumed', function() {
        this.start();
    });

    up.bind('started', function() {

        ok(true, "started event has been dispatched.");

        equal(self.queue.stats.queued, chunksNum,
            chunksNum + " item(s) added to the queue.");

        var item = getItemAt(0, self.queue);
        ok(item instanceof plupload.ChunkUploader,
            "Item is an instance of plupload.ChunkUploader.");


    });

    up.bind('processed', function() {
        QUnit.start();
        plupload.each(dispatched, function(num, type) {
            ok(num > 0, type + ' has been dispatched ' + num + ' times.');
        });
    });

    up.setOption('chunk_size', chunkSize);

    QUnit.stop();
    up.start();
});


// test options immutability in uploadCHunk()

// _options.chunk_size set and not

// check how it is queued on the queue that we pass in

// upload one and monitor progress (although on big part this is already checked in CHunkUploader)

// test before start thing

// send_file_name, target_name, name


</script>
</head>
<body>
	<div id="qunit"></div>
    <div id="qunit-fixture" style="position: relative; top: 0 !important; left: 0 !important; width: 100%; height: 9px;"></div>
</body>
</html>